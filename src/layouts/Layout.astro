---
import { ClientRouter } from "astro:transitions";
import "../global.css";
import Footer from "../components/layouts/Footer.astro";
import Navbar from "../components/layouts/navbar/Navbar.astro";

export interface Props {
  title?: string;
  desc?: string;
  type?: string;
  coverImage?: string;
}

const { title, desc, type, coverImage } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="viewport" content="width=device-width" />
    <!-- SVG favicon for modern browsers -->
    <link rel="icon" type="image/svg+xml" href="/images/favicon/favicon.svg" />
    <!-- PNG fallbacks for modern devices -->
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/images/favicon/favicon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="/images/favicon/favicon-512x512.png"
    />
    <!-- Apple touch icon for iOS -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/images/favicon/apple-touch-icon.png"
    />
    <link rel="manifest" href="/manifest.json" />

    <link rel="me" href="https://linkedin.com/in/fridgren" />

    <!-- Analytics only in deployed site -->
    {
      import.meta.env.PROD && (
        <>
          <script
            defer
            src="https://cloud.umami.is/script.js"
            data-website-id="afa4fdc4-b9ba-493d-84ed-b3ff7a41884f"
          />

          <script
            defer
            src="https://static.cloudflareinsights.com/beacon.min.js"
            data-cf-beacon='{"token":"c2d1eb89e36d42b3af5daa6253a5f323"}'
          />
        </>
      )
    }

    <slot name="head" />

    <ClientRouter />
  </head>
  <body>
    <Navbar />
    <main>
      <slot />
      <Footer />
    </main>

    <style is:global>
      /* Prevent horizontal overflow from full-width elements */
      body {
        position: relative;
      }

      /* Improve Page speed */
      /* https://css-tricks.com/almanac/properties/c/content-visibility/ */
      img {
        content-visibility: auto;
      }

      /* Ensure footer is always above page backgrounds */
      footer {
        position: relative;
        z-index: 10;
      }

      /* Set initial state for GSAP animations to prevent flash */
      .fadeup-st {
        opacity: 0;
        transform: translateY(30px);
      }
    </style>
  </body>
</html>

<script>
  // Import GSAP from local node_modules
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import { initFadeUpAnimations } from "../scripts/fadeup-animations";
  import { initFooterAnimation } from "../scripts/footer-animation";
  import { initNavbar } from "../scripts/navbar";
  import { initMobileMenuLinks } from "../scripts/mobile-menu";

  // Make GSAP globally available
  window.gsap = gsap;
  window.ScrollTrigger = ScrollTrigger;

  // Register ScrollTrigger plugin
  gsap.registerPlugin(ScrollTrigger);

  ScrollTrigger.config({
    autoRefreshEvents: "visibilitychange,DOMContentLoaded,load",
  });

  // Signal that GSAP is ready
  window.gsapReady = true;
  window.dispatchEvent(new Event("gsap-ready"));

  function initAllAnimations() {
    initFadeUpAnimations();
    initFooterAnimation();
    initNavbar();
    initMobileMenuLinks();
  }

  function closeMobileMenu() {
    const mobileMenu = document.getElementById("mobile-menu");
    const menuToggle = document.getElementById("menu-toggle");

    mobileMenu?.classList.remove("open");
    menuToggle?.classList.remove("open");
    document.body.style.overflow = "auto";
    document.body.style.paddingRight = "0";
  }

  // Initialize immediately
  initAllAnimations();

  // Run on every page navigation (View Transitions)
  document.addEventListener("astro:page-load", () => {
    closeMobileMenu();
    initAllAnimations();
  });
</script>
