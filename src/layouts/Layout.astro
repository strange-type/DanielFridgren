---
import { ClientRouter } from "astro:transitions";
import "../global.css";
import Footer from "../components/layouts/Footer.astro";
import Navbar from "../components/layouts/navbar/Navbar.astro";

export interface Props {
  title?: string;
  desc?: string;
  type?: string;
  coverImage?: string;
}

const { title, desc, type, coverImage } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="viewport" content="width=device-width" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/images/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/images/favicon/favicon-16x16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/images/favicon/apple-touch-icon.png"
    />
    <link rel="manifest" href="/manifest.json" />

    <link rel="me" href="https://linkedin.com/in/fridgren" />

    <!-- Analytics -->
    <script
      defer
      src="https://cloud.umami.is/script.js"
      data-website-id="afa4fdc4-b9ba-493d-84ed-b3ff7a41884f"></script>

    <script
      defer
      src="https://static.cloudflareinsights.com/beacon.min.js"
      data-cf-beacon='{"token": "c2d1eb89e36d42b3af5daa6253a5f323"}'></script>

    <ClientRouter />
  </head>
  <body>
    <Navbar />
    <main>
      <slot />
      <Footer />
    </main>

    <style is:global>
      /* Prevent horizontal overflow from full-width elements */
      body {
        position: relative;
      }

      /* Improve Page speed */
      /* https://css-tricks.com/almanac/properties/c/content-visibility/ */
      img {
        content-visibility: auto;
      }

      /* Ensure footer is always above page backgrounds */
      footer {
        position: relative;
        z-index: 10;
      }

      /* Set initial state for GSAP animations to prevent flash */
      .fadeup-st {
        opacity: 0;
        transform: translateY(30px);
      }
    </style>
  </body>
</html>

<script is:inline>
  // Initialize GSAP immediately - inline script runs before module scripts
  (async function () {
    const gsap = await import("https://cdn.skypack.dev/gsap@3");
    const ScrollTrigger = await import(
      "https://cdn.skypack.dev/gsap@3/ScrollTrigger"
    );

    window.gsap = gsap.gsap || gsap.default;
    window.ScrollTrigger = ScrollTrigger.ScrollTrigger || ScrollTrigger.default;

    window.gsap.registerPlugin(window.ScrollTrigger);

    window.ScrollTrigger.config({
      autoRefreshEvents: "visibilitychange,DOMContentLoaded,load",
    });

    // Signal that GSAP is ready
    window.gsapReady = true;
    window.dispatchEvent(new Event("gsap-ready"));
  })();
</script>

<script>
  import { initFadeUpAnimations } from "../scripts/fadeup-animations";
  import { initFooterAnimation } from "../scripts/footer-animation";
  import { initNavbar } from "../scripts/navbar";
  import { initMobileMenuLinks } from "../scripts/mobile-menu";

  function initAllAnimations() {
    initFadeUpAnimations();
    initFooterAnimation();
    initNavbar();
    initMobileMenuLinks();
  }

  function closeMobileMenu() {
    const mobileMenu = document.getElementById("mobile-menu");
    const menuToggle = document.getElementById("menu-toggle");

    mobileMenu?.classList.remove("open");
    menuToggle?.classList.remove("open");
    document.body.style.overflow = "auto";
    document.body.style.paddingRight = "0";
  }

  // Wait for GSAP to be ready
  if (window.gsapReady) {
    initAllAnimations();
  } else {
    window.addEventListener("gsap-ready", initAllAnimations, { once: true });
  }

  // Run on every page navigation (View Transitions)
  document.addEventListener("astro:page-load", () => {
    closeMobileMenu();

    if (window.gsapReady) {
      initAllAnimations();
    } else {
      window.addEventListener("gsap-ready", initAllAnimations, { once: true });
    }
  });
</script>
