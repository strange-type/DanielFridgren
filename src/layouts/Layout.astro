---
import "../global.css";
import Footer from "../components/layouts/Footer.astro";
import Navbar from "../components/layouts/navbar/Navbar.astro";
import HyphenopolyClient from "../components/HyphenopolyClient.astro";

export interface Props {
  title?: string;
  desc?: string;
  type?: string;
  coverImage?: string;
}

const { title, desc, type, coverImage } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="viewport" content="width=device-width" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/images/favicon/favicon-32x32-1.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/images/favicon/favicon-16x16-1.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/images/favicon/apple-touch-icon-1.png"
    />
    <link rel="manifest" href="/manifest.json" />

    <link rel="me" href="https://linkedin.com/in/fridgren" />

    <script
      defer
      src="https://cloud.umami.is/script.js"
      data-website-id="afa4fdc4-b9ba-493d-84ed-b3ff7a41884f"></script>

    <!-- Cloudflare Web Analytics -->
    <script
      defer
      src="https://static.cloudflareinsights.com/beacon.min.js"
      data-cf-beacon='{"token": "c2d1eb89e36d42b3af5daa6253a5f323"}'></script>

    <!-- Privacy-friendly analytics by Visitors.now -->
    <script
      src="https://cdn.visitors.now/v.js"
      data-token="98527db3-c35b-4fed-be98-765cb9db38f5"></script>
  </head>
  <body>
    <HyphenopolyClient />
    <Navbar />
    <main>
      <slot />
      <Footer />
    </main>

    <style is:global>
      /* Prevent horizontal overflow from full-width elements */
      body {
        overflow-x: hidden;
        position: relative;
      }

      /* Improve Page speed */
      /* https://css-tricks.com/almanac/properties/c/content-visibility/ */
      img {
        content-visibility: auto;
        /* Prevent flickering during scroll animations */
        contain-intrinsic-size: auto 400px;
      }

      /* Ensure footer is always above page backgrounds */
      footer {
        position: relative;
        z-index: 10;
      }

      /* Set initial state for GSAP animations to prevent flash */
      .fadeup-st {
        opacity: 0;
        transform: translateY(30px);
      }
    </style>
  </body>
</html>

<script>
  import gsap from "gsap";
  import ScrollTrigger from "gsap/ScrollTrigger";

  window["gsap"] = gsap;
  (window as any).ScrollTrigger = ScrollTrigger;

  gsap.registerPlugin(ScrollTrigger);

  // Configure ScrollTrigger for mobile
  ScrollTrigger.config({
    autoRefreshEvents: "visibilitychange,DOMContentLoaded,load",
  });
</script>

<script type="module">
  (async () => {
    try {
      // register ScrollToPlugin if available (dynamic import) with CDN fallback
      try {
        const { ScrollToPlugin } = await import("gsap/ScrollToPlugin");
        if (ScrollToPlugin && window.gsap)
          window.gsap.registerPlugin(ScrollToPlugin);
      } catch (e) {
        // CDN fallback for ScrollToPlugin
        await new Promise((res) => {
          const s = document.createElement("script");
          s.src =
            "https://cdn.jsdelivr.net/npm/gsap@3/dist/ScrollToPlugin.min.js";
          s.onload = res;
          document.head.appendChild(s);
        });
        if (window.gsap && window.gsap.ScrollToPlugin)
          window.gsap.registerPlugin(window.gsap.ScrollToPlugin);
      }

      if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

      // Fade elements with fadeup-st class
      const sections = window.gsap.utils.toArray(".fadeup-st");

      // Animate to visible state
      sections.forEach((section, i) => {
        // Check if element is in viewport on page load
        const rect = section.getBoundingClientRect();
        const isInitiallyVisible = rect.top < window.innerHeight * 0.9;

        window.gsap.to(section, {
          opacity: 1,
          y: 0,
          duration: 0.9,
          ease: "power4.out",
          scrollTrigger: {
            trigger: section,
            start: "top 85%",
            toggleActions: "play none none none",
            invalidateOnRefresh: true,
            // markers: true, // enable to debug
          },
          // Only add delay for elements initially visible on page load
          delay: isInitiallyVisible ? i * 0.1 : 0,
        });
      });
    } catch (err) {
      console.error("GSAP init/import failed:", err);
    }
  })();
</script>
