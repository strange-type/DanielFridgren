---
import "../global.css";
import Footer from "../components/layouts/Footer.astro";
import Navbar from "../components/layouts/navbar/Navbar.astro";
import HyphenopolyClient from "../components/HyphenopolyClient.astro";

export interface Props {
  title?: string;
  desc?: string;
  type?: string;
  coverImage?: string;
}

const { title, desc, type, coverImage } = Astro.props;

// const canonicalURL = new URL(Astro.request.url, Astro.site).toString();

// Generate OG image URL
// const currentPath = Astro.url.pathname;
// const contentId = currentPath.split("/").filter(Boolean).join("/");

// Use localhost URL in development, production URL otherwise
const baseUrl = import.meta.env.DEV ? "http://localhost:4321" : Astro.site;

// Construct OG image URL - now just using the content ID directly
// const ogImageURL = type
// 	? new URL(`/og/${contentId}.png`, baseUrl)
//	: new URL(`/og.png`, baseUrl);

// Only add search params for non-content pages (like the homepage)
//if (!type) {
//	if (title) ogImageURL.searchParams.set("title", title);
//	if (desc) ogImageURL.searchParams.set("description", desc);
//	if (coverImage) ogImageURL.searchParams.set("coverImage", coverImage);
//}

// Google Analytics type declarations
// declare global {
//	interface Window {
//		dataLayer: any[];
//		gtag: (...args: any[]) => void;
//	}
//}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon/favicon.png" />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Site-wide defaults; page-level SEO comes from seo.astro -->
    <meta property="og:image" content="/images/og-image.png" />
    <meta property="og:type" content="website" />

    <meta name="author" content="Daniel Fridgren" />

    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/images/favicon/favicon-32x32.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <link rel="me" href="https://linkedin.com/in/fridgren" />

    <!-- Privacy-friendly analytics by Plausible and visitors.now -->
    <script
      src="https://cdn.visitors.now/v.js"
      data-token="98527db3-c35b-4fed-be98-765cb9db38f5"></script>
    <script
      defer
      data-domain="fridgren.se"
      src="https://plausible.io/js/script.js"></script>
  </head>
  <body>
    <HyphenopolyClient />
    <Navbar />
    <main>
      <slot />
      <Footer />
    </main>

    <style is:global>
      /* Improve Page speed */
      /* https://css-tricks.com/almanac/properties/c/content-visibility/ */
      img {
        content-visibility: auto;
      }
    </style>
  </body>
</html>

<script>
  import gsap from "gsap";
  import ScrollTrigger from "gsap/ScrollTrigger";
  import Lenis from "lenis";

  window["gsap"] = gsap;
  (window as any).ScrollTrigger = ScrollTrigger;

  gsap.registerPlugin(ScrollTrigger);

  // Only run in the browser
  if (typeof window !== "undefined") {
    const lenis = new Lenis({
      lerp: 0.13, // lower = smoother/slower
      smoothWheel: true,
    });

    function raf(time: number) {
      lenis.raf(time);
      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    lenis.on("scroll", ScrollTrigger.update);
  }
</script>

<script type="module">
  (async () => {
    try {
      // register ScrollToPlugin if available (dynamic import) with CDN fallback
      try {
        const { ScrollToPlugin } = await import("gsap/ScrollToPlugin");
        if (ScrollToPlugin && window.gsap)
          window.gsap.registerPlugin(ScrollToPlugin);
      } catch (e) {
        // CDN fallback for ScrollToPlugin
        await new Promise((res) => {
          const s = document.createElement("script");
          s.src =
            "https://cdn.jsdelivr.net/npm/gsap@3/dist/ScrollToPlugin.min.js";
          s.onload = res;
          document.head.appendChild(s);
        });
        if (window.gsap && window.gsap.ScrollToPlugin)
          window.gsap.registerPlugin(window.gsap.ScrollToPlugin);
      }

      if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

      // Fade elements with fadeup-st class
      const sections = gsap.utils.toArray(".fadeup-st");
      sections.forEach((section, i) => {
        gsap.from(section, {
          autoAlpha: 0,
          y: 50,
          duration: 0.9,
          ease: "power2.out",
          stagger: 0.08,
          scrollTrigger: {
            trigger: section,
            start: "top 90%",
            toggleActions: "play none none reverse",
            // markers: true, // enable to debug
          },
          delay: i * 0.03,
        });
      });
    } catch (err) {
      console.error("GSAP init/import failed:", err);
    }
  })();
</script>
